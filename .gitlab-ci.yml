stages:
  - build
  - deploy

build astro:
  stage: build
  image: oven/bun:1.1-alpine
  variables:
    GIT_SUBMODULE_STRATEGY: "recursive"
    GIT_SUBMODULE_FORCE_HTTPS: "true"
  before_script:
    - bun install --production --frozen-lockfile
  script:
    - bun run build
  artifacts:
    paths:
      - dist
  
deploy cloudflare-pages:
  stage: deploy
  image: oven/bun:1.1-alpine
  script:
    - bunx wrangler pages deploy "dist" --project-name "$CLOUDFLARE_PROJECT_NAME" --branch "$CI_COMMIT_BRANCH" --commit-hash "$CI_COMMIT_SHA" --commit-message "$CI_COMMIT_MESSAGE"
  dependencies:
    - build astro
  rules:
    - if: $CI_COMMIT_REF_NAME != $CI_DEFAULT_BRANCH
      when: manual
    - if: $CLOUDFLARE_ACCOUNT_ID && $CLOUDFLARE_API_TOKEN && CLOUDFLARE_PROJECT_NAME
      when: on_success
    - when: never

pages:
  stage: deploy
  dependencies:
    - build astro
  publish: dist
  rules:
    - if: $CLOUDFLARE_ACCOUNT_ID && $CLOUDFLARE_API_TOKEN && CLOUDFLARE_PROJECT_NAME
      when: never
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      when: on_success
    - when: never